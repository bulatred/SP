<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–≤—Ç–æ–±—É—Å–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .bus-card { margin-bottom: 20px; }
        .sensor-item { padding: 10px; margin: 5px 0; border-radius: 5px; }
        .anomaly { background-color: #ffebee; border-left: 4px solid #f44336; }
        .normal { background-color: #e8f5e9; border-left: 4px solid #4caf50; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–≤—Ç–æ–±—É—Å–æ–≤</h1>
        
        <div id="login-section">
            <h3>–í—Ö–æ–¥</h3>
            <div class="mb-3">
                <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω" class="form-control">
            </div>
            <div class="mb-3">
                <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" class="form-control">
            </div>
            <button onclick="login()" class="btn btn-primary">–í–æ–π—Ç–∏</button>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="mb-3">
                <button onclick="loadBuses()" class="btn btn-success">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button onclick="logout()" class="btn btn-danger">–í—ã–π—Ç–∏</button>
                <button onclick="showImportModal()" class="btn btn-info">–ò–º–ø–æ—Ä—Ç CSV</button>
                <!-- –†—è–¥–æ–º —Å –¥—Ä—É–≥–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ -->
                <button onclick="exportXlsx()" class="btn btn-warning">üìä –≠–∫—Å–ø–æ—Ä—Ç XLSX</button>
                <button onclick="exportCsv()" class="btn btn-warning">üìä –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
                <input type="text" id="newBusModel" placeholder="–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–±—É—Å–∞" class="form-control d-inline w-auto">
                <button onclick="createBus()" class="btn btn-sm btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ–±—É—Å</button>
            </div>
            <div id="buses-container">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –∞–≤—Ç–æ–±—É—Å—ã -->
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ -->
        <div id="uploadModal" style="display:none; position:fixed; top:20%; left:30%; padding:20px; border:1px solid black; background:white; z-index:1000;">
            <h4>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –∞–≤—Ç–æ–±—É—Å–∞</h4>
            <input type="file" id="modalFileInput" accept="image/*" required>
            <button onclick="uploadPhoto()" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button onclick="hideUploadModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        let token = null;
        let currentBusId = null;

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadBuses();
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('buses-container').innerHTML = '';
        }
        
                // –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–±—É—Å–∞
        async function createBus() {
            const model = document.getElementById('newBusModel').value;
            if (!model) return alert('–í–≤–µ–¥–∏—Ç–µ –º–æ–¥–µ–ª—å');
            
            const res = await fetch('/api/buses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model })
            });
            
            if (res.ok) {
                alert('–ê–≤—Ç–æ–±—É—Å —Å–æ–∑–¥–∞–Ω');
                loadBuses();
            } else {
                alert('–û—à–∏–±–∫–∞: —Ç–æ–ª—å–∫–æ ADMIN –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–±—É—Å–∞ (–∫–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç –≤ –∫–∞—Ä—Ç–æ—á–∫–µ)
        async function deleteBus(busId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–±—É—Å?')) return;
            
            const res = await fetch(`/api/buses/${busId}`, { method: 'DELETE' });
            
            if (res.ok) {
                alert('–ê–≤—Ç–æ–±—É—Å —É–¥–∞–ª—ë–Ω');
                loadBuses();
            } else {
                alert('–û—à–∏–±–∫–∞: —Ç–æ–ª—å–∫–æ ADMIN –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å');
            }
        }

        async function loadBuses() {
            const response = await fetch('/api/buses');
            const buses = await response.json();
            
            const container = document.getElementById('buses-container');
            container.innerHTML = '';

            for (const bus of buses) {
                const busCard = document.createElement('div');
                busCard.className = 'bus-card card';
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–∞—Ç—á–∏–∫–æ–≤
                const latestResponse = await fetch(`/api/sensors/latest/${bus.id}`);
                const latestSensors = await latestResponse.json();

                busCard.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">–ê–≤—Ç–æ–±—É—Å: ${bus.model}</h5>
                        
                        ${bus.photoUrl ? `
                            <img src="${bus.photoUrl}" alt="–§–æ—Ç–æ –∞–≤—Ç–æ–±—É—Å–∞" style="max-width: 100%; height: auto; margin-bottom: 10px;">
                            <button onclick="deletePhoto(${bus.id})" class="btn btn-sm btn-outline-danger mb-2">–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</button>
                        ` : '<p>–ù–µ—Ç —Ñ–æ—Ç–æ</p>'}

                        <button onclick="deleteBus(${bus.id})" class="btn btn-sm btn-outline-danger mb-3">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–±—É—Å</button>

                        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ -->
                        <button onclick="showUploadModal(${bus.id})" class="btn btn-sm btn-outline-success mb-3">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>

                        <div id="sensors-${bus.id}">
                            <!-- ENGINE_TEMP -->
                            <div class="mb-3">
                                <h6>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–≤–∏–≥–∞—Ç–µ–ª—è</h6>
                                ${latestSensors.ENGINE_TEMP ? `
                                    <div class="sensor-item ${latestSensors.ENGINE_TEMP.anomaly ? 'anomaly' : 'normal'}">
                                        <strong>${latestSensors.ENGINE_TEMP.value}¬∞C</strong>
                                        <small class="text-muted"> | ${latestSensors.ENGINE_TEMP.timestamp}</small>
                                        ${latestSensors.ENGINE_TEMP.anomaly ? '<span class="badge bg-danger">–ê–ù–û–ú–ê–õ–ò–Ø</span>' : ''}
                                        <button onclick="showHistory(${bus.id}, 'ENGINE_TEMP')" class="btn btn-sm btn-outline-info">–ò—Å—Ç–æ—Ä–∏—è</button>
                                    </div>
                                ` : '<div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'}
                            </div>

                            <!-- FUEL_LEVEL -->
                            <div class="mb-3">
                                <h6>–£—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞</h6>
                                ${latestSensors.FUEL_LEVEL ? `
                                    <div class="sensor-item ${latestSensors.FUEL_LEVEL.anomaly ? 'anomaly' : 'normal'}">
                                        <strong>${latestSensors.FUEL_LEVEL.value}%</strong>
                                        <small class="text-muted"> | ${latestSensors.FUEL_LEVEL.timestamp}</small>
                                        ${latestSensors.FUEL_LEVEL.anomaly ? '<span class="badge bg-danger">–ê–ù–û–ú–ê–õ–ò–Ø</span>' : ''}
                                        <button onclick="showHistory(${bus.id}, 'FUEL_LEVEL')" class="btn btn-sm btn-outline-info">–ò—Å—Ç–æ—Ä–∏—è</button>
                                    </div>
                                ` : '<div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'}
                            </div>

                            <!-- TIRE_PRESSURE -->
                            <div class="mb-3">
                                <h6>–î–∞–≤–ª–µ–Ω–∏–µ –≤ —à–∏–Ω–∞—Ö</h6>
                                ${latestSensors.TIRE_PRESSURE ? `
                                    <div class="sensor-item ${latestSensors.TIRE_PRESSURE.anomaly ? 'anomaly' : 'normal'}">
                                        <strong>${latestSensors.TIRE_PRESSURE.value} –±–∞—Ä</strong>
                                        <small class="text-muted"> | ${latestSensors.TIRE_PRESSURE.timestamp}</small>
                                        ${latestSensors.TIRE_PRESSURE.anomaly ? '<span class="badge bg-danger">–ê–ù–û–ú–ê–õ–ò–Ø</span>' : ''}
                                        <button onclick="showHistory(${bus.id}, 'TIRE_PRESSURE')" class="btn btn-sm btn-outline-info">–ò—Å—Ç–æ—Ä–∏—è</button>
                                    </div>
                                ` : '<div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'}
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(busCard);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∏—Å—Ç–æ—Ä–∏–∏
        async function showHistory(busId, sensorType) {
            const response = await fetch(`/api/sensors/${busId}`);
            const allSensors = await response.json();
            
            const history = allSensors.filter(s => s.sensorType === sensorType);
            
            const container = document.getElementById('buses-container');
            container.innerHTML = `
                <h3>–ò—Å—Ç–æ—Ä–∏—è ${sensorType} –¥–ª—è –∞–≤—Ç–æ–±—É—Å–∞ ${busId}</h3>
                <div>
                    ${history.map(s => `
                        <div class="sensor-item ${s.anomaly ? 'anomaly' : 'normal'}">
                            <strong>${s.value}</strong>
                            <small class="text-muted"> | ${s.timestamp}</small>
                            ${s.anomaly ? '<span class="badge bg-danger">–ê–ù–û–ú–ê–õ–ò–Ø</span>' : ''}
                        </div>
                    `).join('')}
                </div>
                <button onclick="loadBuses()" class="btn btn-primary mt-3">–ù–∞–∑–∞–¥</button>
            `;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
        function showUploadModal(busId) {
            currentBusId = busId;
            document.getElementById('uploadModal').style.display = 'block';
        }

        function hideUploadModal() {
            currentBusId = null;
            document.getElementById('uploadModal').style.display = 'none';
            document.getElementById('modalFileInput').value = ''; // –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ
        }

        async function uploadPhoto() {
            const fileInput = document.getElementById('modalFileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('busId', currentBusId);

            try {
                const res = await fetch('/api/files/upload-photo', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    const text = await res.text();
                    alert(text);
                    hideUploadModal();
                    loadBuses(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                } else {
                    const error = await res.text();
                    alert('–û—à–∏–±–∫–∞: ' + error);
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
        async function deletePhoto(busId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ?')) {
                return;
            }

            try {
                const res = await fetch(`/api/files/delete-photo/${busId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    const text = await res.text();
                    alert(text);
                    loadBuses(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                } else {
                    const error = await res.text();
                    alert('–û—à–∏–±–∫–∞: ' + error);
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–º–ø–æ—Ä—Ç–∞
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }

        function exportCsv() {
            window.location.href = '/api/sensors/export-csv';
        }

        function exportXlsx() {
            // –ú–µ–Ω—è–µ–º URL –Ω–∞ —Ç–≤–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
            window.location.href = '/api/reports/dashboard/export';
        }

        function hideImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importFileInput').value = ''; // –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ
        }

        async function uploadCsv() {
            const fileInput = document.getElementById('importFileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ CSV —Ñ–∞–π–ª—ã');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/sensors/upload', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    const text = await res.text();
                    alert(text);
                    hideImportModal();
                    loadBuses(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                } else {
                    const error = await res.text();
                    alert('–û—à–∏–±–∫–∞: ' + error);
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message);
            }
        }
    </script>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ CSV -->
    <div id="importModal" style="display:none; position:fixed; top:20%; left:30%; padding:20px; border:1px solid black; background:white; z-index:1000;">
        <h4>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—Ç—á–∏–∫–∏ –∏–∑ CSV</h4>
        <input type="file" id="importFileInput" accept=".csv" required>
        <button onclick="uploadCsv()" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <button onclick="hideImportModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
    </div>
</body>
</html>